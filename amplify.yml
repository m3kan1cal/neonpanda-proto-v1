version: 1
applications:
  - appRoot: .
    frontend:
      phases:
        preBuild:
          commands:
            - nvm install 22
            - nvm use 22
            - node -v
            - npm install --cache .npm --prefer-offline --legacy-peer-deps

            # Set the environment variables
            - echo "DYNAMODB_TABLE_NAME=$DYNAMODB_TABLE_NAME" >> .env
            - echo "PINECONE_API_KEY=$PINECONE_API_KEY" >> .env

            # Deploy the backend
            - npx ampx pipeline-deploy --branch $AWS_BRANCH --app-id $AWS_APP_ID
        build:
          commands:
            # Generate Swagger API documentation (reads amplify/swagger/openapi.yaml -> public/api-docs/index.html)
            - npm run swagger:generate

            # Build the frontend
            - npm run build
      artifacts:
        baseDirectory: dist
        files:
          - "**/*"
      cache:
        paths:
          - .npm/**/*
    customHeaders:
      - pattern: "**"
        headers:
          - key: "X-Frame-Options"
            value: "DENY"
          - key: "X-XSS-Protection"
            value: "1; mode=block"
    redirects:
      # Public pages - strip trailing slashes
      - source: "/about/"
        target: "/about"
        status: "301"
      - source: "/technology/"
        target: "/technology"
        status: "301"
      - source: "/privacy/"
        target: "/privacy"
        status: "301"
      - source: "/terms/"
        target: "/terms"
        status: "301"
      - source: "/faqs/"
        target: "/faqs"
        status: "301"
      - source: "/changelog/"
        target: "/changelog"
        status: "301"
      - source: "/contact/"
        target: "/contact"
        status: "301"
      - source: "/blog/"
        target: "/blog"
        status: "301"
      - source: "/welcome/"
        target: "/welcome"
        status: "301"

      # Protected pages - strip trailing slashes
      - source: "/auth/"
        target: "/auth"
        status: "301"
      - source: "/coach-creator/"
        target: "/coach-creator"
        status: "301"
      - source: "/coaches/"
        target: "/coaches"
        status: "301"
      - source: "/settings/"
        target: "/settings"
        status: "301"
      - source: "/training-grounds/"
        target: "/training-grounds"
        status: "301"

      # API docs - serve static Swagger UI (before SPA fallback)
      - source: "/api-docs"
        target: "/api-docs/index.html"
        status: "200"

      # SPA fallback - serve index.html for all other routes
      - source: "/<*>"
        target: "/index.html"
        status: "200"
settings:
  nodeVersion: 22
